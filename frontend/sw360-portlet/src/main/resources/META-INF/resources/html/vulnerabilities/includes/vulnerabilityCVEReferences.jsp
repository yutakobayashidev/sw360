<%--
  ~ Copyright TOSHIBA CORPORATION, 2022. Part of the SW360 Portal Project.
  ~ Copyright Toshiba Software Development (Vietnam) Co., Ltd., 2022. Part of the SW360 Portal Project.
  ~
  ~ This program and the accompanying materials are made
  ~ available under the terms of the Eclipse Public License 2.0
  ~ which is available at https://www.eclipse.org/legal/epl-2.0/
  ~
  ~ SPDX-License-Identifier: EPL-2.0
  --%>
<%@ page import="javax.portlet.PortletRequest" %>
<%@ page import="com.liferay.portal.kernel.portlet.PortletURLFactoryUtil" %>
<%@ page import="com.liferay.portal.kernel.util.PortalUtil" %>
<%@ page import="org.eclipse.sw360.datahandler.thrift.vulnerabilities.Vulnerability" %>

<table id="vulnerabilityCVEReferences" class="table edit-table two-columns-with-actions" >
    <thead>
        <tr>
            <th colspan="3"><liferay-ui:message key="vulnerability.cve.references" /></th>
        </tr>
    </thead>
    <tbody>
        <tr style="display:none" class="cveReferenceRow">
            <td>
                <div class="form-group">
                    <label for="cveYear" class="mandatory"><liferay-ui:message key="vulnerability.cve.year" /></label>
                    <input id="cveYear" class="form-control cve-year" type="number" placeholder="<liferay-ui:message key="enter.cve.year" />"
                        name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_CVE_YEAR%>"
                        onkeydown="return event.keyCode !== 69 && event.keyCode !== 107 && event.keyCode !== 109 && event.keyCode !== 189"
                        onKeyPress="if(this.value.length==4) return false;"/>
                    <div class="invalid-feedback">
                        <liferay-ui:message key="please.enter.cve.year" />
                    </div>
                    <div class="cve-year-invalid" style="color:red; display:none; font-weight: bold">
                        <liferay-ui:message key="cve.year.must.be.greater.than.0" />
                    </div>
                </div>
            </td>
            <td>
                <div class="form-group">
                    <label for="cveNumber" class="mandatory"><liferay-ui:message key="vulnerability.cve.number" /></label>
                    <input id="cveNumber" class="form-control cve-number" type="number" placeholder="<liferay-ui:message key="enter.cve.number" />"
                        name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_CVE_NUMBER%>"
                        onkeydown="return event.keyCode !== 69 && event.keyCode !== 107 && event.keyCode !== 109 && event.keyCode !== 189"
                        onKeyPress="if(this.value.length==9) return false;"/>
                    <div class="invalid-feedback">
                        <liferay-ui:message key="please.enter.cve.number" />
                    </div>
                    <div class="cve-number-invalid" style="color:red; display:none; font-weight: bold">
                        <liferay-ui:message key="cve.number.must.be.positive.number" />
                    </div>
                </div>
            </td>
            <td class="content-middle">
                <svg class="action lexicon-icon delete-cve-btn" style="margin-top:25px">
                   <title>Delete</title>
                   <use href="/o/org.eclipse.sw360.liferay-theme/images/clay/icons.svg#trash"/>
                </svg>
            </td>
        </tr>
        <core_rt:if test="${not addMode}" >
            <core_rt:forEach var="cveReference" items="${vulnerability.cveReferences}" varStatus="loop">
                <tr class="cveReferenceRow">
                    <td>
                        <label for="cveYear" class="mandatory"><liferay-ui:message key="vulnerability.cve.year" /></label>
                        <input id="cveYear" type="number" class="form-control cve-year" type="number" placeholder="<liferay-ui:message key="enter.cve.year" />"
                             value="<sw360:out value='${cveReference.year}'/>" name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_CVE_YEAR%>"
                             onkeydown="return event.keyCode !== 69 && event.keyCode !== 107 && event.keyCode !== 109 && event.keyCode !== 189"
                             onKeyPress="if(this.value.length==4) return false;"/>
                        <div class="invalid-feedback">
                            <liferay-ui:message key="please.enter.cve.year" />
                        </div>
                        <div class="cve-year-invalid" style="color:red; display:none; font-weight: bold">
                            <liferay-ui:message key="cve.year.must.be.greater.than.0" />
                        </div>
                    </td>
                    <td>
                        <label for="cveNumber" class="mandatory"><liferay-ui:message key="vulnerability.cve.number" /></label>
                        <div class="form-group">
                            <input id="cveNumber" type="number" class="form-control cve-number" type="number" placeholder="<liferay-ui:message key="enter.cve.number" />"
                               value="<sw360:out value='${cveReference.number}'/>" name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_CVE_NUMBER%>"
                               onkeydown="return event.keyCode !== 69 && event.keyCode !== 107 && event.keyCode !== 109 && event.keyCode !== 189"
                               onKeyPress="if(this.value.length==9) return false;"/>
                            <div class="invalid-feedback">
                                <liferay-ui:message key="please.enter.cve.number" />
                            </div>
                            <div class="cve-number-invalid" style="color:red; display:none; font-weight: bold">
                                <liferay-ui:message key="cve.number.must.be.positive.number" />
                            </div>
                        </div>
                    </td>
                    <td class="content-middle">
                        <svg class="action lexicon-icon delete-cve-btn" style="margin-top:25px">
                            <title>Delete</title>
                            <use href="/o/org.eclipse.sw360.liferay-theme/images/clay/icons.svg#trash"/>
                        </svg>
                    </td>
                </tr>
            </core_rt:forEach>
        </core_rt:if>
    </tbody>
</table>
<button type="button" class="btn btn-secondary" id="add-cve-btn">
    <liferay-ui:message key="click.to.add.cve.reference" />
</button>

<%@ include file="/html/utils/includes/requirejs.jspf" %>
<script>
    require(['jquery'], function($) {
         //======================Vulnerability CVE References=========================//
         $('.delete-cve-btn').on('click',deleteCveReferenceVulnerabilityRow);
         $(document).ready(function(){
            $('input[type=number]').on("paste",function(e) {
               e.preventDefault();
            });
         });
         $('#add-cve-btn').on('click', function() {
              if ($('.cveReferenceRow').last().css('display') == 'none') {
                  $('.cveReferenceRow').first().css('display', 'table-row');
                  $(".cve-year").last().attr("required", true);
                  $(".cve-number").last().attr("required", true);
                  return;
              }
              let newRow = $(".cveReferenceRow").last().clone().css('display','table-row');
              $('#vulnerabilityCVEReferences').find('tbody').append(newRow);
              $('.cve-year').last().val('');
              $('.cve-number').last().val('');
              $(".cve-year").last().attr("required", true);
              $(".cve-number").last().attr("required", true);
              $('.delete-cve-btn').last().bind('click', deleteCveReferenceVulnerabilityRow);
              $('.cve-number').last().bind('paste', function(e){e.preventDefault()});
              $('.cve-year').last().bind('paste', function(e){e.preventDefault()});
         });

         function deleteCveReferenceVulnerabilityRow() {
             if ($('.delete-cve-btn').length > 1) {
                 $(this).closest('tr').remove();
             } else {
                 $('.cve-year').last().val('');
                 $('.cve-number').last().val('');
                 $(".cve-year").last().attr("required", false);
                 $(".cve-number").last().attr("required", false);
                 $(this).closest('tr').css('display', 'none');
             }
         }
    });
</script>