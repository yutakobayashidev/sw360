<%--
  ~ Copyright TOSHIBA CORPORATION, 2022. Part of the SW360 Portal Project.
  ~ Copyright Toshiba Software Development (Vietnam) Co., Ltd., 2022. Part of the SW360 Portal Project.
  ~
  ~ This program and the accompanying materials are made
  ~ available under the terms of the Eclipse Public License 2.0
  ~ which is available at https://www.eclipse.org/legal/epl-2.0/
  ~
  ~ SPDX-License-Identifier: EPL-2.0
  --%>
<%@ page import="javax.portlet.PortletRequest" %>
<%@ page import="com.liferay.portal.kernel.portlet.PortletURLFactoryUtil" %>
<%@ page import="com.liferay.portal.kernel.util.PortalUtil" %>
<%@ page import="org.eclipse.sw360.datahandler.thrift.vulnerabilities.Vulnerability" %>

<table id="vulnerabilityVendorAdvisories" class="table edit-table three-columns-with-actions" >
    <thead>
        <tr>
            <th colspan="4"><liferay-ui:message key="vulnerability.vendor.advisories" /></th>
        </tr>
    </thead>
    <tbody>
        <tr style="display:none" class="advisoryVendorRow">
            <td>
                <div class="form-group">
                    <label for="advisoryVendor" class="mandatory"><liferay-ui:message key="vulnerability.advisory.vendor" /></label>
                    <input id="advisoryVendor" class="form-control advisory-vendor" placeholder="<liferay-ui:message key="enter.vendor.advisory.vendor" />"
                        name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_ADVISORY_VENDOR%>"/>
                    <div class="invalid-feedback">
                         <liferay-ui:message key="please.enter.vendor.advisory.vendor" />
                    </div>
               </div>
            </td>
            <td>
                <div class="form-group">
                    <label for="advisoryName" class="mandatory"><liferay-ui:message key="vulnerability.advisory.name" /></label>
                    <input id="advisoryName" class="form-control advisory-name" placeholder="<liferay-ui:message key="please.enter.vendor.advisory.name" />"
                         name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_ADVISORY_NAME%>" />
                    <div class="invalid-feedback">
                        <liferay-ui:message key="please.enter.vendor.advisory.name" />
                    </div>
                </div>
            </td>
            <td >
                 <div class="form-group">
                    <label for="advisoryUrl" class="mandatory"><liferay-ui:message key="vulnerability.advisory.url" /></label>
                    <input id="advisoryUrl"  class="form-control advisory-url" placeholder="<liferay-ui:message key="please.enter.vendor.advisory.url" />"
                         name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_ADVISORY_URL%>"
                         pattern="(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,}|http:\/\/localhost.*)"
                         />
                    <div class="invalid-feedback">
                        <liferay-ui:message key="please.enter.vendor.advisory.url" />
                    </div>
                </div>
            </td>
            <td>
                <svg class="action lexicon-icon delete-advisory-btn" style="margin-top:33px">
                    <title>Delete</title>
                    <use href="/o/org.eclipse.sw360.liferay-theme/images/clay/icons.svg#trash"/>
                </svg>
            </td>
        </tr>
        <core_rt:if test="${not addMode}" >
            <core_rt:forEach var="vendorAdvisory" items="${vulnerability.vendorAdvisories}" varStatus="loop">
                <tr class="advisoryVendorRow">
                    <td>
                        <div class="form-group">
                            <label for="advisoryVendor" class="mandatory"><liferay-ui:message key="vulnerability.advisory.vendor" /></label>
                            <input id="advisoryVendor"  class="form-control advisory-vendor" placeholder="<liferay-ui:message key="enter.vendor.advisory.vendor" />"
                                value="<sw360:out value='${vendorAdvisory.vendor}'/>"
                                name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_ADVISORY_VENDOR%>"
                                required/>
                            <div class="invalid-feedback">
                                <liferay-ui:message key="please.enter.vendor.advisory.vendor" />
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <label for="advisoryName" class="mandatory"><liferay-ui:message key="vulnerability.advisory.name" /></label>
                            <input id="advisoryName"  class="form-control advisory-name" placeholder="<liferay-ui:message key="please.enter.vendor.advisory.name" />"
                                value="<sw360:out value='${vendorAdvisory.name}'/>"
                                name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_ADVISORY_NAME%>"
                                required/>
                            <div class="invalid-feedback">
                                <liferay-ui:message key="please.enter.vendor.advisory.name" />
                            </div>
                        </div>
                    </td>
                    <td >
                        <div class="form-group">
                            <label for="advisoryUrl" class="mandatory"><liferay-ui:message key="vulnerability.advisory.url" /></label>
                            <input id="advisoryUrl"  class="form-control advisory-url" placeholder="<liferay-ui:message key="please.enter.vendor.advisory.url" />"
                                value="<sw360:out value='${vendorAdvisory.url}'/>"
                                name="<portlet:namespace/><%=PortalConstants.VULNERABILITY_ADVISORY_URL%>"
                                required pattern="(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,}|http:\/\/localhost.*)"/>
                            <div class="invalid-feedback">
                                <liferay-ui:message key="please.enter.vendor.advisory.url" />
                            </div>
                        </div>
                    </td>
                    <td>
                        <svg class="action lexicon-icon delete-advisory-btn" style="margin-top:33px">
                        <title>Delete</title>
                        <use href="/o/org.eclipse.sw360.liferay-theme/images/clay/icons.svg#trash"/>
                        </svg>
                    </td>
                </tr>
            </core_rt:forEach>
        </core_rt:if>
    </tbody>
</table>

<button type="button" class="btn btn-secondary" id="add-advisory-vendor">
      <liferay-ui:message key="click.to.add.vendor.advisory" />
</button>

<%@ include file="/html/utils/includes/requirejs.jspf" %>
<script>
    require(['jquery'], function($) {
        //======================Vulnerability Vendor Advisory=========================//
        $('.delete-advisory-btn').on('click',deleteAdvisoryRow);

        $('#add-advisory-vendor').on('click', function() {
            if ($('.advisoryVendorRow').last().css('display') == 'none') {
                $('.advisoryVendorRow').first().css('display', 'table-row');
                $(".advisory-vendor").last().attr("required", true);
                $(".advisory-name").last().attr("required", true);
                $(".advisory-url").last().attr("required", true);
                return;
            }
            let newRow = $(".advisoryVendorRow").last().clone().css('display','table-row');
            $('#vulnerabilityVendorAdvisories').find('tbody').append(newRow);
            $('.advisory-vendor').last().val('');
            $('.advisory-name').last().val('');
            $('.advisory-url').last().val('');
            $(".advisory-vendor").last().attr("required", true);
            $(".advisory-name").last().attr("required", true);
            $(".advisory-url").last().attr("required", true);
            $('.delete-advisory-btn').last().bind('click', deleteAdvisoryRow);
        });

        function deleteAdvisoryRow() {
            if ($('.delete-advisory-btn').length > 1) {
                $(this).closest('tr').remove();
            } else {
                $('.advisory-vendor').last().val('');
                $('.advisory-name').last().val('');
                $('.advisory-url').last().val('');
                $(".advisory-vendor").last().attr("required", false);
                $(".advisory-name").last().attr("required", false);
                $(".advisory-url").last().attr("required", false);
                $(this).closest('tr').css('display', 'none');
            }
        }
    });
</script>